import React, { useState } from 'react';
import { Trophy, Award, Star, CheckCircle, XCircle, Clock, Users, AlertTriangle } from 'lucide-react';

const foodSafetyQuestions = [
  // CRITICAL Y/N QUESTIONS (FS1-FS7) - These cause automatic failure
  {
    id: 1,
    question: "What is the minimum internal temperature for beef patties after cooking?",
    options: ["145¬∞F", "150¬∞F", "155¬∞F", "165¬∞F"],
    correct: 2,
    category: "CRITICAL - Cooking Temps",
    ecosureRef: "FS2",
    isCritical: true,
    explanation: "Beef patties MUST be cooked to at or above 155¬∞F. This is a CRITICAL question - if patties are below 155¬∞F during inspection, you automatically fail."
  },
  {
    id: 2,
    question: "What is the minimum internal temperature for raw chicken products after cooking?",
    options: ["155¬∞F", "160¬∞F", "165¬∞F", "170¬∞F"],
    correct: 2,
    category: "CRITICAL - Cooking Temps",
    ecosureRef: "FS3",
    isCritical: true,
    explanation: "Raw chicken products MUST be cooked to at or above 165¬∞F. This is a CRITICAL question - missing this means automatic inspection failure."
  },
  {
    id: 3,
    question: "What is the minimum internal temperature for Filet-O-Fish portions after cooking?",
    options: ["145¬∞F", "150¬∞F", "155¬∞F", "165¬∞F"],
    correct: 2,
    category: "CRITICAL - Cooking Temps",
    ecosureRef: "FS4",
    isCritical: true,
    explanation: "Filet-O-Fish MUST be cooked to at or above 155¬∞F. This is a CRITICAL question that causes automatic failure if missed."
  },
  {
    id: 4,
    question: "What is the minimum internal temperature for breakfast sausage (raw pork) and breakfast steak?",
    options: ["145¬∞F", "155¬∞F", "165¬∞F", "175¬∞F"],
    correct: 1,
    category: "CRITICAL - Cooking Temps",
    ecosureRef: "FS5",
    isCritical: true,
    explanation: "Breakfast sausage and steak MUST be at or above 155¬∞F. CRITICAL question - automatic failure if incorrect."
  },
  {
    id: 5,
    question: "What must be true about cooked McMuffin raw round eggs?",
    options: ["Yolks are runny and at 145¬∞F", "Yolks are gelled (not runny) and at 155¬∞F+", "Yolks are gelled and at 145¬∞F", "Any temperature is acceptable"],
    correct: 1,
    category: "CRITICAL - Cooking Temps",
    ecosureRef: "FS6",
    isCritical: true,
    explanation: "McMuffin round eggs MUST have gelled (not runny) yolks AND be at or above 155¬∞F. CRITICAL - this is automatic failure."
  },
  {
    id: 6,
    question: "The on-duty manager must be able to demonstrate what regarding the Food Safety Daily Checklist?",
    options: ["Just know where it's located", "How to complete it and take corrective action", "How to complete it only", "Where to file it"],
    correct: 1,
    category: "CRITICAL - Management",
    ecosureRef: "FS7",
    isCritical: true,
    explanation: "Manager MUST demonstrate proper training on completing the checklist AND ability to take corrective action. CRITICAL failure point."
  },
  {
    id: 7,
    question: "What indicates pest infestation that would cause automatic inspection failure?",
    options: ["Seeing one fly", "Signs of active pest infestation in restaurant, corral, or within 10 feet of building", "Old mouse droppings outside", "Ants in the parking lot"],
    correct: 1,
    category: "CRITICAL - Pest Control",
    ecosureRef: "FS1",
    isCritical: true,
    explanation: "ANY signs of active pest infestation in the restaurant, adjoining corral, or within 10 feet of building is CRITICAL automatic failure."
  },
  
  // HIGH-VALUE (5 POINT) QUESTIONS
  {
    id: 8,
    question: "What must be available at ALL handwashing sinks?",
    options: ["Just soap", "Just warm water", "Running warm water and required supplies (soap, towels, signage)", "Cold water and soap"],
    correct: 2,
    category: "Hygiene - 5 Points",
    ecosureRef: "FS9",
    isCritical: false,
    explanation: "All handwashing sinks MUST have running warm water, soap, paper towels, and proper signage. Sinks must be easily accessed and used ONLY for handwashing. Worth 5 points."
  },
  {
    id: 9,
    question: "What system must be in place for employee handwashing?",
    options: ["Employees wash when they want", "Hourly and activity-based handwashing by ALL employees", "Once per shift minimum", "Only when visibly dirty"],
    correct: 1,
    category: "Hygiene - 5 Points",
    ecosureRef: "FS10",
    isCritical: false,
    explanation: "A system MUST be in place for hourly AND activity-based handwashing (after touching raw food, using restroom, etc.). Worth 5 points."
  },
  {
    id: 10,
    question: "What color gloves MUST be used when handling raw meat or poultry products at the grill?",
    options: ["Any color is fine", "Blue or colored disposable gloves", "Clear gloves only", "No gloves needed"],
    correct: 1,
    category: "Hygiene - 5 Points",
    ecosureRef: "FS18",
    isCritical: false,
    explanation: "Blue or colored disposable gloves MUST be used to prevent cross-contamination when handling raw meat/poultry (including shell eggs). Worth 5 points."
  },
  {
    id: 11,
    question: "Walk-in freezers must keep products at what temperature?",
    options: ["10¬∞F or below", "5¬∞F or below", "0¬∞F or below", "Any frozen temp"],
    correct: 2,
    category: "Temperature Control - 5 Points",
    ecosureRef: "FS23",
    isCritical: false,
    explanation: "Walk-in freezers and primary storage freezers MUST maintain 0¬∞F or below. Secondary freezers must keep products solid. Worth 5 points."
  },
  {
    id: 12,
    question: "Walk-in refrigerators must keep products at what temperature?",
    options: ["45¬∞F or below", "42¬∞F or below", "40¬∞F or below", "38¬∞F or below"],
    correct: 2,
    category: "Temperature Control - 5 Points",
    ecosureRef: "FS24",
    isCritical: false,
    explanation: "Walk-in refrigerators and primary storage refrigerators MUST maintain at or below 40¬∞F (including shake/sundae reservoir). Worth 5 points."
  },
  {
    id: 13,
    question: "What must be true about the pyrometer (thermometer)?",
    options: ["Just needs to work", "Clean, calibrated, working correctly, and used correctly", "Working and stored properly", "Any functioning thermometer"],
    correct: 1,
    category: "Equipment - 5 Points",
    ecosureRef: "FS27",
    isCritical: false,
    explanation: "Pyrometer and probes MUST be clean, calibrated, working correctly, AND used correctly. Worth 5 points."
  },
  {
    id: 14,
    question: "All TCS (Time/Temperature Control for Safety) refrigerated products must be:",
    options: ["Used within 7 days", "In code (within primary shelf life)", "Labeled with any date", "Stored at any cold temp"],
    correct: 1,
    category: "Time-Temp Control - 5 Points",
    ecosureRef: "FS8",
    isCritical: false,
    explanation: "ALL TCS refrigerated products MUST be in code (within primary shelf life). Expired products cause violations. Worth 5 points."
  },
  {
    id: 15,
    question: "When can an employee with vomiting or diarrhea work?",
    options: ["After 24 hours", "After symptoms stop", "Managers must know when employee can return per regulations", "Whenever they feel better"],
    correct: 2,
    category: "Employee Health - 5 Points",
    ecosureRef: "FS29",
    isCritical: false,
    explanation: "Managers MUST understand illness symptoms, reportable causes, and when employees can return to work after illness. Worth 5 points."
  },
  {
    id: 16,
    question: "How many days of Daily Food Safety Checklists (DFSC) must be available?",
    options: ["30 days", "45 days", "60 days", "90 days"],
    correct: 2,
    category: "Documentation - 5 Points",
    ecosureRef: "FS31",
    isCritical: false,
    explanation: "Last 60 days of DFSC and past 2 Monthly Food Safety Procedures Verifications (MFSPV) must be available. No more than 20% missed/incorrect. Worth 5 points."
  },
  {
    id: 17,
    question: "All food, packaging, equipment, and chemicals must be from:",
    options: ["Any reputable supplier", "Approved sources", "The cheapest supplier", "Local suppliers"],
    correct: 1,
    category: "Sourcing - 5 Points",
    ecosureRef: "FS28",
    isCritical: false,
    explanation: "ALL food, packaging, equipment (including utensils), and cleaning chemicals MUST be from approved sources. Worth 5 points."
  },
  
  // MEDIUM-VALUE (3 POINT) QUESTIONS
  {
    id: 18,
    question: "How often must UHC trays, grill utensils, prep utensils, and utensil holders be washed, rinsed, and sanitized?",
    options: ["Every 2 hours", "Every 4 hours", "Every 6 hours", "Once per shift"],
    correct: 1,
    category: "Sanitization - 3 Points",
    ecosureRef: "FS13",
    isCritical: false,
    explanation: "All in-use UHC trays, grill utensils, prep table utensils, and utensil holders MUST be clean, washed, rinsed, and sanitized at least every 4 hours. Worth 3 points."
  },
  {
    id: 19,
    question: "What is the minimum wash water temperature for the back sink when washing utensils?",
    options: ["100¬∞F", "110¬∞F", "120¬∞F", "130¬∞F"],
    correct: 1,
    category: "Sanitization - 3 Points",
    ecosureRef: "FS13",
    isCritical: false,
    explanation: "Back sink wash water MUST be 110¬∞F or higher. Sanitizer solution must be correct concentration checked with test strip. Worth 3 points."
  },
  {
    id: 20,
    question: "What must be checked with a test strip in sanitized towel buckets?",
    options: ["Water temperature", "Chlorine sanitizer concentration", "pH level", "Water clarity"],
    correct: 1,
    category: "Sanitization - 3 Points",
    ecosureRef: "FS11",
    isCritical: false,
    explanation: "Sanitized towel buckets MUST contain towels and chlorine sanitizer at correct concentration checked with chlorine test strip. Worth 3 points."
  },
  {
    id: 21,
    question: "Opened packages of food in storage must be:",
    options: ["Just labeled", "Covered/wrapped, labeled, off floor, away from walls", "Covered only", "Stored anywhere cold"],
    correct: 1,
    category: "Storage - 3 Points",
    ecosureRef: "FS17",
    isCritical: false,
    explanation: "Opened food packages in ALL storage (dry, refrigerator, freezer) MUST be covered/wrapped, labeled, off the floor, and away from walls. Worth 3 points."
  },
  {
    id: 22,
    question: "Leftover heated foods and expired UHC products must be:",
    options: ["Saved for later", "Discarded", "Re-heated", "Cooled and stored"],
    correct: 1,
    category: "Time-Temp Control - 3 Points",
    ecosureRef: "FS26",
    isCritical: false,
    explanation: "ALL leftover heated foods MUST be discarded (including expired UHC food and shake mix removed from heat treatment). Proteins can't be held below 140¬∞F or beyond defined time. Worth 3 points."
  },
  {
    id: 23,
    question: "All chemicals must be:",
    options: ["Stored anywhere convenient", "Clearly labeled and stored away from food and packaging", "In original containers only", "Locked up"],
    correct: 1,
    category: "Chemical Safety - 3 Points",
    ecosureRef: "FS20",
    isCritical: false,
    explanation: "ALL chemicals MUST be clearly labeled and stored AWAY from food and packaging to prevent contamination. Worth 3 points."
  },
  {
    id: 24,
    question: "In-use refrigerated products at room temperature must be:",
    options: ["Marked and used within primary shelf life", "Marked and used within secondary shelf life", "Used within 4 hours", "Discarded after 2 hours"],
    correct: 1,
    category: "Time-Temp Control - 3 Points",
    ecosureRef: "FS25",
    isCritical: false,
    explanation: "All in-use refrigerated products held in refrigerators OR at room temperature MUST be marked and used within their SECONDARY shelf lives. Worth 3 points."
  },
  {
    id: 25,
    question: "The restaurant must be free of:",
    options: ["Minor dust", "Dust/dirt/food build-up, and standing water", "Any dirt", "Visible stains"],
    correct: 1,
    category: "Cleanliness - 3 Points",
    ecosureRef: "FS14",
    isCritical: false,
    explanation: "ALL areas must be in good state of cleanliness. Floors/walls/ceiling/equipment can't have dust/dirt/food build-up. No standing water pools. Worth 3 points."
  }
];

const LOCATIONS = ["Olympia", "Peters", "Duquesne", "Waterfront"];

const badgeTypes = [
  { name: "Critical Master", icon: "üéØ", requirement: "100% on all critical questions", color: "bg-red-100 text-red-800" },
  { name: "Temp Expert", icon: "üå°Ô∏è", requirement: "Perfect temperature questions", color: "bg-orange-100 text-orange-800" },
  { name: "Sanitation Pro", icon: "‚ú®", requirement: "Perfect sanitization questions", color: "bg-blue-100 text-blue-800" },
  { name: "Perfect Week", icon: "‚≠ê", requirement: "7 day streak", color: "bg-yellow-100 text-yellow-800" },
  { name: "Inspection Ready", icon: "üëë", requirement: "90%+ average last 10 quizzes", color: "bg-green-100 text-green-800" }
];

export default function FoodSafetyApp() {
  const [screen, setScreen] = useState('login');
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showExplanation, setShowExplanation] = useState(false);
  const [score, setScore] = useState(0);
  const [quizQuestions, setQuizQuestions] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [userAnswers, setUserAnswers] = useState([]);
  const [managerName, setManagerName] = useState('');
  const [selectedLocation, setSelectedLocation] = useState('');
  const [leaderboard, setLeaderboard] = useState([]);

  const handleLogin = (e) => {
    if (e) e.preventDefault();
    if (managerName.trim() && selectedLocation) {
      const initials = managerName.split(' ').map(n => n[0]).join('').toUpperCase();
      setCurrentUser({
        name: managerName.trim(),
        location: selectedLocation,
        avatar: initials,
        score: 0,
        streak: 0,
        badges: 0,
        criticalMastery: 0
      });
      setScreen('home');
    }
  };

  const addToLeaderboard = (userResult) => {
    const percentage = (userResult.score / (quizQuestions.length * 10)) * 100;
    if (percentage >= 80) {
      const newEntry = {
        id: Date.now(),
        name: userResult.name,
        location: userResult.location,
        avatar: userResult.avatar,
        score: userResult.score,
        criticalMastery: userResult.criticalMastery,
        timestamp: new Date().toISOString()
      };
      setLeaderboard(prev => {
        const updated = [...prev, newEntry];
        return updated.sort((a, b) => b.score - a.score).slice(0, 20);
      });
    }
  };

  const startQuiz = () => {
    const criticalQuestions = foodSafetyQuestions.filter(q => q.isCritical);
    const nonCriticalQuestions = foodSafetyQuestions.filter(q => !q.isCritical);
    
    // All 7 critical questions
    const selectedCritical = [...criticalQuestions].sort(() => Math.random() - 0.5);
    // 5 random non-critical questions
    const selectedNonCritical = [...nonCriticalQuestions].sort(() => Math.random() - 0.5).slice(0, 5);
    
    // Combine and shuffle for 12 total questions
    const shuffled = [...selectedCritical, ...selectedNonCritical].sort(() => Math.random() - 0.5);
    
    setQuizQuestions(shuffled);
    setCurrentQuestion(0);
    setScore(0);
    setSelectedAnswer(null);
    setShowExplanation(false);
    setUserAnswers([]);
    setScreen('quiz');
  };

  const handleAnswerSelect = (answerIndex) => {
    if (showExplanation) return;
    setSelectedAnswer(answerIndex);
  };

  const handleSubmitAnswer = () => {
    const question = quizQuestions[currentQuestion];
    const isCorrect = selectedAnswer === question.correct;
    const newAnswers = [...userAnswers, { 
      questionId: question.id, 
      correct: isCorrect,
      isCritical: question.isCritical,
      ecosureRef: question.ecosureRef
    }];
    setUserAnswers(newAnswers);
    
    if (isCorrect) {
      setScore(score + 10);
    }
    setShowExplanation(true);
  };

  const handleNextQuestion = () => {
    if (currentQuestion < quizQuestions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      setSelectedAnswer(null);
      setShowExplanation(false);
    } else {
      // Calculate critical mastery
      const criticalAnswers = userAnswers.filter(a => a.isCritical);
      const criticalCorrect = criticalAnswers.filter(a => a.correct).length;
      const criticalMastery = criticalAnswers.length > 0 ? Math.round((criticalCorrect / criticalAnswers.length) * 100) : 0;
      
      // Add to leaderboard if passing
      addToLeaderboard({
        name: currentUser.name,
        location: currentUser.location,
        avatar: currentUser.avatar,
        score: score,
        criticalMastery: criticalMastery
      });
      
      setScreen('results');
    }
  };

  const getScoreMessage = () => {
    const criticalAnswers = userAnswers.filter(a => a.isCritical);
    const criticalMissed = criticalAnswers.filter(a => !a.correct);
    const percentage = (score / (quizQuestions.length * 10)) * 100;
    
    if (criticalMissed.length > 0) {
      return { 
        text: `CRITICAL FAILURE: You missed ${criticalMissed.length} critical question(s)!`, 
        color: "text-red-600",
        subtext: "In a real inspection, you would FAIL. Review all critical questions immediately."
      };
    }
    
    if (percentage >= 80) return { 
      text: "Excellent! You passed and got all critical questions!", 
      color: "text-green-600",
      subtext: "Your store is inspection-ready!"
    };
    
    if (percentage >= 60) return { 
      text: "Good! Critical questions passed, but review missed questions.", 
      color: "text-yellow-600",
      subtext: "Focus on improving non-critical areas."
    };
    
    return { 
      text: "Needs improvement. Study the material and retake.", 
      color: "text-orange-600",
      subtext: "While you passed critical questions, overall score is low."
    };
  };

  if (screen === 'login') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-yellow-400 via-red-500 to-red-600 p-6 flex items-center justify-center">
        <div className="max-w-md w-full">
          <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div className="bg-red-600 p-8 text-white text-center">
              <div className="text-6xl mb-4">üçî</div>
              <h1 className="text-3xl font-bold mb-2">Welcome Manager!</h1>
              <p className="text-lg opacity-90">Roberts Management Food Safety</p>
            </div>

            <div className="p-8">
              <form onSubmit={handleLogin}>
                <div className="mb-6">
                  <label className="block text-gray-700 font-bold mb-2">Your Name</label>
                  <input
                    type="text"
                    value={managerName}
                    onChange={(e) => setManagerName(e.target.value)}
                    placeholder="Enter your full name"
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-red-500 focus:outline-none text-lg"
                  />
                </div>

                <div className="mb-8">
                  <label className="block text-gray-700 font-bold mb-2">Your Location</label>
                  <select
                    value={selectedLocation}
                    onChange={(e) => setSelectedLocation(e.target.value)}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-red-500 focus:outline-none text-lg"
                  >
                    <option value="">Select your restaurant</option>
                    {LOCATIONS.map((loc) => (
                      <option key={loc} value={loc}>{loc}</option>
                    ))}
                  </select>
                </div>

                <button
                  type="submit"
                  disabled={!managerName.trim() || !selectedLocation}
                  className={`w-full py-4 rounded-xl font-bold text-xl ${
                    managerName.trim() && selectedLocation
                      ? 'bg-red-600 hover:bg-red-700 text-white transform transition hover:scale-105'
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  Start Training
                </button>
              </form>

              <div className="mt-6 text-center">
                <button
                  onClick={() => setScreen('leaderboard')}
                  className="text-red-600 hover:text-red-700 font-semibold"
                >
                  View Leaderboard ‚Üí
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (screen === 'home') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-yellow-400 via-red-500 to-red-600 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div className="bg-red-600 p-8 text-white text-center">
              <div className="text-6xl mb-4">üçî</div>
              <h1 className="text-4xl font-bold mb-2">Roberts Management Food Safety</h1>
              <p className="text-xl opacity-90">McDonald's Inspection Readiness</p>
            </div>

            <div className="p-8">
              <div className="bg-red-50 border-2 border-red-400 rounded-xl p-4 mb-6 flex items-start gap-3">
                <AlertTriangle className="text-red-600 flex-shrink-0 mt-1" size={24} />
                <div>
                  <h3 className="font-bold text-red-800 mb-1">Critical Questions = Automatic Failure</h3>
                  <p className="text-red-700 text-sm">This quiz includes CRITICAL Y/N questions from Ecosure. Missing even ONE critical question in a real inspection means you FAIL, regardless of your other scores.</p>
                </div>
              </div>

              <div className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6 mb-8">
                <div className="flex items-center gap-4 mb-4">
                  <div className="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                    {currentUser?.avatar || 'M'}
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-gray-800">{currentUser?.name || 'Manager'}</h2>
                    <p className="text-gray-600">{currentUser?.location || 'Location'}</p>
                  </div>
                </div>
                <div className="grid grid-cols-4 gap-4 mt-4">
                  <div className="bg-white rounded-lg p-4 text-center">
                    <div className="text-3xl font-bold text-red-600">{currentUser?.score || 0}</div>
                    <div className="text-sm text-gray-600">Points</div>
                  </div>
                  <div className="bg-white rounded-lg p-4 text-center">
                    <div className="text-3xl font-bold text-yellow-600">{currentUser?.streak || 0}</div>
                    <div className="text-sm text-gray-600">Streak</div>
                  </div>
                  <div className="bg-white rounded-lg p-4 text-center">
                    <div className="text-3xl font-bold text-green-600">{currentUser?.criticalMastery || 0}%</div>
                    <div className="text-sm text-gray-600">Critical</div>
                  </div>
                  <div className="bg-white rounded-lg p-4 text-center">
                    <div className="text-3xl font-bold text-blue-600">{currentUser?.badges || 0}</div>
                    <div className="text-sm text-gray-600">Badges</div>
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <button
                  onClick={startQuiz}
                  className="w-full bg-red-600 hover:bg-red-700 text-white text-xl font-bold py-6 rounded-xl shadow-lg transform transition hover:scale-105"
                >
                  Start Daily Quiz (12 Questions)
                </button>
                <button
                  onClick={() => setScreen('leaderboard')}
                  className="w-full bg-yellow-500 hover:bg-yellow-600 text-white text-xl font-bold py-6 rounded-xl shadow-lg transform transition hover:scale-105"
                >
                  View Leaderboard
                </button>
                <button
                  onClick={() => setScreen('login')}
                  className="w-full bg-gray-500 hover:bg-gray-600 text-white text-lg font-bold py-4 rounded-xl shadow-lg"
                >
                  Change Manager
                </button>
              </div>

              <div className="mt-8 bg-gray-50 rounded-xl p-6">
                <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                  <Award className="text-yellow-500" />
                  Available Badges
                </h3>
                <div className="grid grid-cols-2 gap-3">
                  {badgeTypes.slice(0, Math.max(currentUser?.badges || 0, 2)).map((badge, idx) => (
                    <div key={idx} className={`${badge.color} rounded-lg p-3 text-center`}>
                      <div className="text-2xl mb-1">{badge.icon}</div>
                      <div className="font-bold text-sm">{badge.name}</div>
                      <div className="text-xs opacity-75 mt-1">{badge.requirement}</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (screen === 'quiz') {
    const question = quizQuestions[currentQuestion];
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-400 to-blue-600 p-6">
        <div className="max-w-3xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div className="bg-blue-600 p-6 text-white">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-2">
                  <Clock size={20} />
                  <span>Question {currentQuestion + 1} of {quizQuestions.length}</span>
                </div>
                <div className="flex items-center gap-2">
                  <Star className="fill-yellow-300 text-yellow-300" size={20} />
                  <span className="font-bold">{score} pts</span>
                </div>
              </div>
              <div className="w-full bg-blue-800 rounded-full h-2">
                <div 
                  className="bg-yellow-400 h-2 rounded-full transition-all"
                  style={{ width: `${((currentQuestion + 1) / quizQuestions.length) * 100}%` }}
                />
              </div>
            </div>

            <div className="p-8">
              {question.isCritical && (
                <div className="mb-4 bg-red-50 border-2 border-red-400 rounded-lg p-3 flex items-center gap-2">
                  <AlertTriangle className="text-red-600" size={20} />
                  <span className="text-red-800 font-bold text-sm">CRITICAL QUESTION - Automatic failure if wrong in real inspection</span>
                </div>
              )}
              
              <div className="mb-6">
                <div className="flex items-center gap-2 mb-3">
                  <span className={`inline-block ${question.isCritical ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'} px-3 py-1 rounded-full text-sm font-semibold`}>
                    {question.category}
                  </span>
                  <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                    Ecosure: {question.ecosureRef}
                  </span>
                </div>
                <h2 className="text-2xl font-bold text-gray-800">{question.question}</h2>
              </div>

              <div className="space-y-3 mb-6">
                {question.options.map((option, index) => {
                  let bgColor = 'bg-gray-50 hover:bg-gray-100';
                  let borderColor = 'border-gray-300';
                  
                  if (showExplanation) {
                    if (index === question.correct) {
                      bgColor = 'bg-green-100';
                      borderColor = 'border-green-500';
                    } else if (index === selectedAnswer && index !== question.correct) {
                      bgColor = 'bg-red-100';
                      borderColor = 'border-red-500';
                    }
                  } else if (selectedAnswer === index) {
                    bgColor = 'bg-blue-100';
                    borderColor = 'border-blue-500';
                  }

                  return (
                    <button
                      key={index}
                      onClick={() => handleAnswerSelect(index)}
                      disabled={showExplanation}
                      className={`w-full text-left p-4 rounded-xl border-2 ${bgColor} ${borderColor} transition-all ${!showExplanation && 'cursor-pointer'}`}
                    >
                      <div className="flex items-center justify-between">
                        <span className="font-medium">{option}</span>
                        {showExplanation && index === question.correct && (
                          <CheckCircle className="text-green-600" size={24} />
                        )}
                        {showExplanation && index === selectedAnswer && index !== question.correct && (
                          <XCircle className="text-red-600" size={24} />
                        )}
                      </div>
                    </button>
                  );
                })}
              </div>

              {showExplanation && (
                <div className={`${question.isCritical ? 'bg-red-50 border-red-300' : 'bg-blue-50 border-blue-300'} border-2 rounded-xl p-4 mb-6`}>
                  <h3 className={`font-bold ${question.isCritical ? 'text-red-900' : 'text-blue-900'} mb-2`}>Explanation:</h3>
                  <p className={question.isCritical ? 'text-red-800' : 'text-blue-800'}>{question.explanation}</p>
                </div>
              )}

              {!showExplanation ? (
                <button
                  onClick={handleSubmitAnswer}
                  disabled={selectedAnswer === null}
                  className={`w-full py-4 rounded-xl font-bold text-lg ${
                    selectedAnswer === null
                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      : 'bg-red-600 hover:bg-red-700 text-white'
                  }`}
                >
                  Submit Answer
                </button>
              ) : (
                <button
                  onClick={handleNextQuestion}
                  className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg"
                >
                  {currentQuestion < quizQuestions.length - 1 ? 'Next Question' : 'View Results'}
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (screen === 'results') {
    const scoreMsg = getScoreMessage();
    const percentage = (score / (quizQuestions.length * 20)) * 100;
    const criticalAnswers = userAnswers.filter(a => a.isCritical);
    const criticalCorrect = criticalAnswers.filter(a => a.correct).length;
    const criticalMissed = criticalAnswers.filter(a => !a.correct);

    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-400 to-purple-600 p-6">
        <div className="max-w-3xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div className="bg-purple-600 p-8 text-white text-center">
              <div className="text-6xl mb-4">{criticalMissed.length === 0 ? 'üéâ' : '‚ö†Ô∏è'}</div>
              <h1 className="text-4xl font-bold mb-2">Quiz Complete!</h1>
            </div>

            <div className="p-8">
              {criticalMissed.length > 0 && (
                <div className="bg-red-100 border-2 border-red-400 rounded-xl p-6 mb-6">
                  <div className="flex items-center gap-3 mb-3">
                    <AlertTriangle className="text-red-600" size={32} />
                    <h2 className="text-2xl font-bold text-red-800">INSPECTION FAILURE</h2>
                  </div>
                  <p className="text-red-700 font-semibold mb-2">
                    You missed {criticalMissed.length} CRITICAL question(s). In a real Ecosure inspection, you would automatically FAIL.
                  </p>
                  <p className="text-red-600 text-sm">Critical questions missed:</p>
                  <ul className="mt-2 space-y-1">
                    {criticalMissed.map((ans, idx) => {
                      const q = quizQuestions.find(qu => qu.id === ans.questionId);
                      return (
                        <li key={idx} className="text-red-700 text-sm font-medium">
                          ‚Ä¢ {ans.ecosureRef}: {q.category}
                        </li>
                      );
                    })}
                  </ul>
                </div>
              )}

              <div className="grid grid-cols-2 gap-4 mb-6">
                <div className="bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-xl p-6 text-center">
                  <div className="text-5xl font-bold text-white mb-2">{score}</div>
                  <div className="text-xl text-white font-semibold">Total Points</div>
                  <div className="text-lg text-white opacity-90 mt-1">{percentage.toFixed(0)}% Correct</div>
                  <div className="text-sm text-white opacity-80 mt-1">Max: {quizQuestions.length * 10}</div>
                </div>
                <div className={`${criticalMissed.length === 0 ? 'bg-gradient-to-r from-green-400 to-green-500' : 'bg-gradient-to-r from-red-400 to-red-500'} rounded-xl p-6 text-center`}>
                  <div className="text-5xl font-bold text-white mb-2">{criticalCorrect}/{criticalAnswers.length}</div>
                  <div className="text-xl text-white font-semibold">Critical Questions</div>
                  <div className="text-lg text-white opacity-90 mt-1">
                    {criticalMissed.length === 0 ? 'PASS ‚úì' : 'FAIL ‚úó'}
                  </div>
                </div>
              </div>

              <div className={`${criticalMissed.length === 0 ? 'bg-green-50 border-green-300' : 'bg-yellow-50 border-yellow-300'} border-2 rounded-xl p-6 mb-8 text-center`}>
                <h2 className={`text-2xl font-bold mb-2 ${scoreMsg.color}`}>
                  {scoreMsg.text}
                </h2>
                <p className="text-gray-600">{scoreMsg.subtext}</p>
              </div>

              <div className="bg-gray-50 rounded-xl p-6 mb-8">
                <h3 className="font-bold text-lg mb-4">Question Summary</h3>
                <div className="space-y-2">
                  {quizQuestions.map((q, idx) => {
                    const answer = userAnswers[idx];
                    return (
                      <div key={idx} className={`flex items-center justify-between p-3 rounded-lg ${answer.isCritical ? 'bg-red-50' : 'bg-white'}`}>
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            {answer.isCritical && <AlertTriangle size={16} className="text-red-600" />}
                            <span className="text-sm font-medium">Q{idx + 1}: {q.category}</span>
                          </div>
                          <span className="text-xs text-gray-500">{q.ecosureRef}</span>
                        </div>
                        {answer.correct ? (
                          <CheckCircle className="text-green-600" size={20} />
                        ) : (
                          <XCircle className="text-red-600" size={20} />
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              <div className="space-y-3">
                <button
                  onClick={() => setScreen('home')}
                  className="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-xl font-bold text-lg"
                >
                  Back to Home
                </button>
                <button
                  onClick={() => setScreen('leaderboard')}
                  className="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-4 rounded-xl font-bold text-lg"
                >
                  View Leaderboard
                </button>
                <button
                  onClick={startQuiz}
                  className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg"
                >
                  Retake Quiz
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (screen === 'leaderboard') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-400 to-green-600 p-6">
        <div className="max-w-5xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div className="bg-green-600 p-8 text-white text-center">
              <Trophy size={64} className="mx-auto mb-4" />
              <h1 className="text-4xl font-bold mb-2">Manager Leaderboard</h1>
              <p className="text-xl opacity-90">Top Performers - Inspection Readiness</p>
            </div>

            <div className="p-8">
              <div className="grid grid-cols-3 gap-4 mb-8">
                {leaderboard.slice(0, 3).map((manager, idx) => {
                  const podiumColors = ['bg-yellow-400', 'bg-gray-300', 'bg-orange-400'];
                  const podiumText = ['text-yellow-800', 'text-gray-700', 'text-orange-800'];
                  return (
                    <div key={manager.id} className={`${podiumColors[idx]} rounded-xl p-6 text-center`}>
                      <div className="text-4xl mb-2">{idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â'}</div>
                      <div className={`w-16 h-16 bg-white rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-3 ${podiumText[idx]}`}>
                        {manager.avatar}
                      </div>
                      <div className="font-bold text-lg">{manager.name}</div>
                      <div className="text-sm opacity-75">{manager.location}</div>
                      <div className={`text-2xl font-bold mt-2 ${podiumText[idx]}`}>{manager.score} pts</div>
                      <div className="text-sm font-semibold mt-1">Critical: {manager.criticalMastery}%</div>
                    </div>
                  );
                })}
              </div>

              <div className="bg-gray-50 rounded-xl p-6">
                <h3 className="font-bold text-xl mb-4 flex items-center gap-2">
                  <Users />
                  Top Performers - Ranked by Score
                </h3>
                {leaderboard.length === 0 ? (
                  <div className="text-center py-12">
                    <div className="text-6xl mb-4">üéØ</div>
                    <p className="text-gray-600 text-lg font-semibold">No managers on leaderboard yet!</p>
                    <p className="text-gray-500 mt-2">Complete a quiz with 80% or higher to appear here.</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {leaderboard.map((manager, idx) => (
                      <div key={manager.id} className="bg-white rounded-lg p-4 flex items-center justify-between hover:shadow-md transition-shadow">
                        <div className="flex items-center gap-4">
                          <div className={`text-2xl font-bold ${idx < 3 ? 'text-yellow-600' : 'text-gray-400'} w-8`}>
                            #{idx + 1}
                          </div>
                          <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center text-white font-bold">
                            {manager.avatar}
                          </div>
                          <div>
                            <div className="font-bold">{manager.name}</div>
                            <div className="text-sm text-gray-600">{manager.location}</div>
                          </div>
                        </div>
                        <div className="flex items-center gap-6">
                          <div className="text-right">
                            <div className="text-2xl font-bold text-red-600">{manager.score}</div>
                            <div className="text-xs text-gray-500">points</div>
                          </div>
                          <div className="text-right">
                            <div className="text-lg font-bold text-green-600">{manager.criticalMastery}%</div>
                            <div className="text-xs text-gray-500">critical</div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div className="mt-6 bg-blue-50 border-2 border-blue-300 rounded-xl p-4">
                <h4 className="font-bold text-blue-900 mb-2">üéØ Critical Mastery Explained</h4>
                <p className="text-blue-800 text-sm">This percentage shows how well each manager performs on CRITICAL questions (FS1-FS7). These are the automatic failure questions on Ecosure inspections. Aim for 100%!</p>
              </div>

              <button
                onClick={() => setScreen('login')}
                className="w-full mt-6 bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg"
              >
                Change Manager
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return null;
}